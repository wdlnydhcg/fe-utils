{"version":3,"file":"index.js","sources":["../../../src/index.ts"],"sourcesContent":["const HEARTBEAT_PING_TIMEOUT = 2 * 1000\nconst HEARTBEAT_PONG_TIMEOUT = 5 * 1000\nconst RECONNECT_TIMEOUT = 5 * 1000\nconst REPEAT_LIMIT = 5\n\nexport interface IILLAWebSocketOptions {\n  repeat: number\n  lockReconnect: boolean\n  forbidReconnect: boolean\n  pingTimeoutId: number\n  pongTimeoutId: number\n  isOnline: boolean\n}\n\nconst DEFAULT_PING_MESSAGE = JSON.stringify({\n  signal: 0,\n  option: 0,\n  target: 0,\n  payload: [],\n  broadcast: null,\n})\n\nexport default abstract class ILLAWebSocket {\n  ws: WebSocket | null = null\n  url: string\n  options: IILLAWebSocketOptions = {\n    repeat: 0,\n    lockReconnect: false,\n    forbidReconnect: false,\n    pingTimeoutId: -1,\n    pongTimeoutId: -1,\n    isOnline: true,\n  }\n\n  protected constructor(url: string) {\n    this.url = url\n  }\n\n  abstract onMessageCallback(event: MessageEvent): void\n\n  abstract onOpenCallback(): void\n\n  abstract onOnlineChangeCallback(isOnline: boolean): void\n\n  private createWebsocket() {\n    try {\n      this.ws = new WebSocket(this.url)\n      this.initEventHandle()\n    } catch (e) {\n      this.reconnect()\n      throw e\n    }\n  }\n\n  private initEventHandle() {\n    if (this.ws) {\n      this.ws.onclose = () => {\n        this.reconnect()\n      }\n      this.ws.onerror = () => {\n        this.reconnect()\n      }\n      this.ws.onopen = () => {\n        console.log(`[WS OPENED](${this.url}) connection succeeded`)\n        this.options.isOnline = true\n        this.options.repeat = 0\n        this.heartCheck()\n        this.onOpenCallback()\n      }\n      this.ws.onmessage = (event) => {\n        this.onMessageCallback(event)\n        this.heartCheck()\n      }\n    }\n  }\n\n  private reconnect() {\n    if (this.options.forbidReconnect) return\n    if (this.options.isOnline) {\n      this.options.isOnline = false\n      this.onOnlineChangeCallback(this.options.isOnline)\n    }\n    if (REPEAT_LIMIT <= this.options.repeat) return\n    if (this.options.lockReconnect) return\n    this.options.lockReconnect = true\n    this.options.repeat++\n    setTimeout(() => {\n      this.createWebsocket()\n      this.options.lockReconnect = false\n    }, RECONNECT_TIMEOUT)\n  }\n\n  private heartCheck() {\n    this.heartReset()\n    this.heartStart()\n  }\n  private heartStart() {\n    if (this.options.forbidReconnect) return\n    this.options.pingTimeoutId = window.setTimeout(() => {\n      this.ws?.send(DEFAULT_PING_MESSAGE)\n      this.options.pongTimeoutId = window.setTimeout(() => {\n        if (this.options.isOnline) {\n          this.options.isOnline = false\n          this.onOnlineChangeCallback(this.options.isOnline)\n        }\n        this.ws?.close()\n      }, HEARTBEAT_PONG_TIMEOUT)\n    }, HEARTBEAT_PING_TIMEOUT)\n  }\n  private heartReset() {\n    clearTimeout(this.options.pingTimeoutId)\n    clearTimeout(this.options.pongTimeoutId)\n  }\n\n  public close() {\n    this.options.forbidReconnect = true\n    this.heartReset()\n    this.ws?.close()\n  }\n  public send(message: string) {\n    try {\n      this.ws?.send(message)\n    } catch (e) {\n      console.error(e)\n    }\n  }\n}\n"],"names":["DEFAULT_PING_MESSAGE","ILLAWebSocket","url","__publicField","e","event","_a","message"],"mappings":"+YAcA,MAAMA,EAAuB,KAAK,UAAU,CAC1C,OAAQ,EACR,OAAQ,EACR,OAAQ,EACR,QAAS,CAAE,EACX,UAAW,IACZ,CAAA,EAED,MAA8BC,CAAa,CAYzC,YAAsBC,EAAW,CAXjCC,EAAA,UAAuB,MACvBA,EAAA,YACAA,EAAA,eAAiC,CAC/B,OAAQ,EACR,cAAe,GACf,gBAAiB,GACjB,cAAe,GACf,cAAe,GACf,SAAU,EAAA,GAIV,KAAK,IAAMD,CACb,CAQQ,iBAAe,CACjB,GAAA,CACF,KAAK,GAAK,IAAI,UAAU,KAAK,GAAG,EAChC,KAAK,gBAAe,QACbE,GACP,WAAK,UAAS,EACRA,CACP,CACH,CAEQ,iBAAe,CACjB,KAAK,KACF,KAAA,GAAG,QAAU,IAAK,CACrB,KAAK,UAAS,CAAA,EAEX,KAAA,GAAG,QAAU,IAAK,CACrB,KAAK,UAAS,CAAA,EAEX,KAAA,GAAG,OAAS,IAAK,CACZ,QAAA,IAAI,eAAe,KAAK,2BAA2B,EAC3D,KAAK,QAAQ,SAAW,GACxB,KAAK,QAAQ,OAAS,EACtB,KAAK,WAAU,EACf,KAAK,eAAc,CAAA,EAEhB,KAAA,GAAG,UAAaC,GAAS,CAC5B,KAAK,kBAAkBA,CAAK,EAC5B,KAAK,WAAU,CAAA,EAGrB,CAEQ,WAAS,CACX,KAAK,QAAQ,kBACb,KAAK,QAAQ,WACf,KAAK,QAAQ,SAAW,GACnB,KAAA,uBAAuB,KAAK,QAAQ,QAAQ,GAE/C,KAAgB,KAAK,QAAQ,UAC7B,KAAK,QAAQ,gBACjB,KAAK,QAAQ,cAAgB,GAC7B,KAAK,QAAQ,SACb,WAAW,IAAK,CACd,KAAK,gBAAe,EACpB,KAAK,QAAQ,cAAgB,IAC5B,GAAiB,IACtB,CAEQ,YAAU,CAChB,KAAK,WAAU,EACf,KAAK,WAAU,CACjB,CACQ,YAAU,CACZ,KAAK,QAAQ,kBACjB,KAAK,QAAQ,cAAgB,OAAO,WAAW,IAAK,QAC7CC,EAAA,KAAA,KAAA,MAAAA,EAAI,KAAKN,GACd,KAAK,QAAQ,cAAgB,OAAO,WAAW,IAAK,OAC9C,KAAK,QAAQ,WACf,KAAK,QAAQ,SAAW,GACnB,KAAA,uBAAuB,KAAK,QAAQ,QAAQ,IAEnDM,EAAA,KAAK,KAAL,MAAAA,EAAS,SACR,GAAsB,GACxB,GAAsB,EAC3B,CACQ,YAAU,CACH,aAAA,KAAK,QAAQ,aAAa,EAC1B,aAAA,KAAK,QAAQ,aAAa,CACzC,CAEO,OAAK,OACV,KAAK,QAAQ,gBAAkB,GAC/B,KAAK,WAAU,GACfA,EAAA,KAAK,KAAL,MAAAA,EAAS,OACX,CACO,KAAKC,EAAe,OACrB,GAAA,EACGD,EAAA,KAAA,KAAA,MAAAA,EAAI,KAAKC,SACPH,GACP,QAAQ,MAAMA,CAAC,CAChB,CACH,CACD"}