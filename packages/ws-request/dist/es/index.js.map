{"version":3,"file":"index.js","sources":["../../../src/index.ts"],"sourcesContent":["const HEARTBEAT_PING_TIMEOUT = 2 * 1000\nconst HEARTBEAT_PONG_TIMEOUT = 5 * 1000\nconst RECONNECT_TIMEOUT = 5 * 1000\nconst REPEAT_LIMIT = 5\n\nexport interface IILLAWebSocketOptions {\n  repeat: number\n  lockReconnect: boolean\n  forbidReconnect: boolean\n  pingTimeoutId: number\n  pongTimeoutId: number\n  isOnline: boolean\n}\n\nconst DEFAULT_PING_MESSAGE = JSON.stringify({\n  signal: 0,\n  option: 0,\n  target: 0,\n  payload: [],\n  broadcast: null,\n})\n\nexport default abstract class ILLAWebSocket {\n  ws: WebSocket | null = null\n  url: string\n  options: IILLAWebSocketOptions = {\n    repeat: 0,\n    lockReconnect: false,\n    forbidReconnect: false,\n    pingTimeoutId: -1,\n    pongTimeoutId: -1,\n    isOnline: true,\n  }\n\n  protected constructor(url: string) {\n    this.url = url\n  }\n\n  abstract onMessageCallback(event: MessageEvent): void\n\n  abstract onOpenCallback(): void\n\n  abstract onOnlineChangeCallback(isOnline: boolean): void\n\n  private createWebsocket() {\n    try {\n      this.ws = new WebSocket(this.url)\n      this.initEventHandle()\n    } catch (e) {\n      this.reconnect()\n      throw e\n    }\n  }\n\n  private initEventHandle() {\n    if (this.ws) {\n      this.ws.onclose = () => {\n        this.reconnect()\n      }\n      this.ws.onerror = () => {\n        this.reconnect()\n      }\n      this.ws.onopen = () => {\n        console.log(`[WS OPENED](${this.url}) connection succeeded`)\n        this.options.isOnline = true\n        this.options.repeat = 0\n        this.heartCheck()\n        this.onOpenCallback()\n      }\n      this.ws.onmessage = (event) => {\n        this.onMessageCallback(event)\n        this.heartCheck()\n      }\n    }\n  }\n\n  private reconnect() {\n    if (this.options.forbidReconnect) return\n    if (this.options.isOnline) {\n      this.options.isOnline = false\n      this.onOnlineChangeCallback(this.options.isOnline)\n    }\n    if (REPEAT_LIMIT <= this.options.repeat) return\n    if (this.options.lockReconnect) return\n    this.options.lockReconnect = true\n    this.options.repeat++\n    setTimeout(() => {\n      this.createWebsocket()\n      this.options.lockReconnect = false\n    }, RECONNECT_TIMEOUT)\n  }\n\n  private heartCheck() {\n    this.heartReset()\n    this.heartStart()\n  }\n  private heartStart() {\n    if (this.options.forbidReconnect) return\n    this.options.pingTimeoutId = window.setTimeout(() => {\n      this.ws?.send(DEFAULT_PING_MESSAGE)\n      this.options.pongTimeoutId = window.setTimeout(() => {\n        if (this.options.isOnline) {\n          this.options.isOnline = false\n          this.onOnlineChangeCallback(this.options.isOnline)\n        }\n        this.ws?.close()\n      }, HEARTBEAT_PONG_TIMEOUT)\n    }, HEARTBEAT_PING_TIMEOUT)\n  }\n  private heartReset() {\n    clearTimeout(this.options.pingTimeoutId)\n    clearTimeout(this.options.pongTimeoutId)\n  }\n\n  public close() {\n    this.options.forbidReconnect = true\n    this.heartReset()\n    this.ws?.close()\n  }\n  public send(message: string) {\n    try {\n      this.ws?.send(message)\n    } catch (e) {\n      console.error(e)\n    }\n  }\n}\n"],"names":["DEFAULT_PING_MESSAGE","ILLAWebSocket","url","__publicField","e","event","_a","message"],"mappings":";;;AAcA,MAAMA,IAAuB,KAAK,UAAU;AAAA,EAC1C,QAAQ;AAAA,EACR,QAAQ;AAAA,EACR,QAAQ;AAAA,EACR,SAAS,CAAE;AAAA,EACX,WAAW;AACZ,CAAA;AAED,MAA8BC,EAAa;AAAA,EAYzC,YAAsBC,GAAW;AAXjC,IAAAC,EAAA,YAAuB;AACvB,IAAAA,EAAA;AACA,IAAAA,EAAA,iBAAiC;AAAA,MAC/B,QAAQ;AAAA,MACR,eAAe;AAAA,MACf,iBAAiB;AAAA,MACjB,eAAe;AAAA,MACf,eAAe;AAAA,MACf,UAAU;AAAA,IAAA;AAIV,SAAK,MAAMD;AAAA,EACb;AAAA,EAQQ,kBAAe;AACjB,QAAA;AACF,WAAK,KAAK,IAAI,UAAU,KAAK,GAAG,GAChC,KAAK,gBAAe;AAAA,aACbE;AACP,iBAAK,UAAS,GACRA;AAAA,IACP;AAAA,EACH;AAAA,EAEQ,kBAAe;AACrB,IAAI,KAAK,OACF,KAAA,GAAG,UAAU,MAAK;AACrB,WAAK,UAAS;AAAA,IAAA,GAEX,KAAA,GAAG,UAAU,MAAK;AACrB,WAAK,UAAS;AAAA,IAAA,GAEX,KAAA,GAAG,SAAS,MAAK;AACZ,cAAA,IAAI,eAAe,KAAK,2BAA2B,GAC3D,KAAK,QAAQ,WAAW,IACxB,KAAK,QAAQ,SAAS,GACtB,KAAK,WAAU,GACf,KAAK,eAAc;AAAA,IAAA,GAEhB,KAAA,GAAG,YAAY,CAACC,MAAS;AAC5B,WAAK,kBAAkBA,CAAK,GAC5B,KAAK,WAAU;AAAA,IAAA;AAAA,EAGrB;AAAA,EAEQ,YAAS;AACf,IAAI,KAAK,QAAQ,oBACb,KAAK,QAAQ,aACf,KAAK,QAAQ,WAAW,IACnB,KAAA,uBAAuB,KAAK,QAAQ,QAAQ,IAE/C,OAAgB,KAAK,QAAQ,YAC7B,KAAK,QAAQ,kBACjB,KAAK,QAAQ,gBAAgB,IAC7B,KAAK,QAAQ,UACb,WAAW,MAAK;AACd,WAAK,gBAAe,GACpB,KAAK,QAAQ,gBAAgB;AAAA,OAC5B,GAAiB;AAAA,EACtB;AAAA,EAEQ,aAAU;AAChB,SAAK,WAAU,GACf,KAAK,WAAU;AAAA,EACjB;AAAA,EACQ,aAAU;AAChB,IAAI,KAAK,QAAQ,oBACjB,KAAK,QAAQ,gBAAgB,OAAO,WAAW,MAAK;AAlGxD,UAAAC;AAmGW,OAAAA,IAAA,KAAA,OAAA,QAAAA,EAAI,KAAKN,IACd,KAAK,QAAQ,gBAAgB,OAAO,WAAW,MAAK;AApG1D,YAAAM;AAqGY,QAAA,KAAK,QAAQ,aACf,KAAK,QAAQ,WAAW,IACnB,KAAA,uBAAuB,KAAK,QAAQ,QAAQ,KAEnDA,IAAA,KAAK,OAAL,QAAAA,EAAS;AAAA,SACR,GAAsB;AAAA,OACxB,GAAsB;AAAA,EAC3B;AAAA,EACQ,aAAU;AACH,iBAAA,KAAK,QAAQ,aAAa,GAC1B,aAAA,KAAK,QAAQ,aAAa;AAAA,EACzC;AAAA,EAEO,QAAK;AAlHd,QAAAA;AAmHI,SAAK,QAAQ,kBAAkB,IAC/B,KAAK,WAAU,IACfA,IAAA,KAAK,OAAL,QAAAA,EAAS;AAAA,EACX;AAAA,EACO,KAAKC,GAAe;AAvH7B,QAAAD;AAwHQ,QAAA;AACG,OAAAA,IAAA,KAAA,OAAA,QAAAA,EAAI,KAAKC;AAAA,aACPH;AACP,cAAQ,MAAMA,CAAC;AAAA,IAChB;AAAA,EACH;AACD;"}